var univ = {
    isOnline: false,
    framerateUnlocked: false,
    dtUpperLimit: 1000 / 15,//1000 / 30,
    denybuttons: false,
    showFramerate: false,
    imageSmoothingEnabled: true,
    imageSmoothingQuality: "high", // options: "low", "medium", "high"
    canvasStyleImageRendering: "smooth",
    fontFile: null, // "resources/victoriabold.png" //set to null otherwise
    filesList: "", //space-separated
    on_each_start: null,
    on_first_run: null,
    on_next_game_once: null,
    on_beforeunload: null,
    allowQuietReload: true,
    acquireNameMoreStr: "(English name + homeroom)"
}





class Game extends GameCore {
    //#region more
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ///                                             customize here                                                   ///
    /// ////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ///                                                                                                              ///
    ///         these are called  when appropriate                                                                   ///
    ///                                                                                                              ///
    ///         initialize_more                                                                                      ///                                   
    ///         draw_more                                                                                            ///
    ///         update_more                                                                                          ///
    ///         next_loop_more                                                                                       ///
    ///                                                                                                              ///
    ///                                                                                                              ///
    ///                                                                                                              ///
    ///                                                                                                              ///
    ///                                                                                                              ///
    ///                                                                                                              ///
    ///                                                                                                              ///
    ///                                                                                                              ///
    ///                                                                                                              ///
    ///                                                                                                              ///
    ///                                                                                                              ///
    ///                                                                                                              ///
    ///                                                                                                              ///
    ///                                                                                                              ///
    ///                                             INITIALIZE                                                       ///
    /// start initialize_more:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
    //#endregion
    //#region initialize_more
    initialize_more() {
        const ADDBUTTONS = true

        const what = !ADDBUTTONS || prompt(
            `Each graph represents the 6, 24, or 120 possible states of Alain's card shuffling game.
Which graph do you want? (Type in the number)
1: three cards, tangled
2: three cards, untangled
3: four cards, tangled
4: four cards, untangled
5: five cards, tangled
6: five cards, untangled (recommended)
7: six cards, a mess (not recommended)
            `)
        alert("drag&drop with mouse, zoom with mousewheel")
        let [NR, NRROWS, NRCOLS, NRARRANGE] = [
            [3, 3, 2, false], [3, 3, 2, true],
            [4, 6, 4, false], [4, 6, 4, true],
            [5, 12, 10, false], [5, 12, 10, true],
            [6, 24, 30, false],
            //[7, 70, 72, false]
        ][what - 1]
        if (!ADDBUTTONS) NR = 8
        const Card = function (str) {
            this.str = str
            this.after = undefined
            this.afterArrowColor = "black"//MM.randomColor(0, 150)
            if (!ADDBUTTONS) return
            this.button = new Button({
                width: 150,
                height: 75,
                tag: this,
                txt: str,
                fontSize: NR == 4 ? 32 : 24,
                isBlocking: true
            })
            Button.make_draggable(this.button)
            game.add_drawable(this.button)
        }
        const cards = new Map()

        for (const str of MM.permutationsStr(Array.from({ length: NR }, (_, i) => `${i + 1}`).join(""))) {//NR
            cards.set(str, new Card(str))
        }
        if (ADDBUTTONS) {
            const buttons = Array.from(cards.values().map(x => x.button))
            const cX = game.rect.centerX
            const cY = game.rect.centerY
            const sfBase = 1.08
            Rect.packArray(buttons,
                this.rect.copy.deflate(100, 100).splitGrid(NRROWS, NRCOLS).flat()
                    .map(x => x.resize(70, 30))
                , true)//NR
            const bg = Button.fromRect(game.rect.copy)
            if (NR == 6) buttons.forEach(x => (x.stretch(.5, .5), x.fontSize *= .5))

            bg.transparent = true
            bg.on_wheel = function (wheel, pos) {
                const sf = wheel > 0 ? 1 / sfBase : sfBase
                buttons.forEach(x => {
                    x.spread(pos.x, pos.y, sf, sf)
                    x.stretch(sf, sf)
                    x.fontSize *= sf
                })
            }
            this.add_drawable(bg, 4)
            Button.make_drag_others(bg, buttons, true)
        }
        globalThis.cards = cards
        console.log(cards)

        const shuffle = function (card) {
            if (card.str[0] == "1") {
                card.after = null
                return null
            }
            const top = Number(card.str[0])
            const reversedPart = Array.from(card.str).slice(0, top).toReversed()
            const keptPart = Array.from(card.str).slice(top)
            const after = reversedPart.concat(keptPart).join("")
            card.after = cards.get(after)
            return cards.get(after)
        }
        for (const card of cards.values()) {
            shuffle(card)
        }
        const parents = new Set(cards.values().filter(x => x.str[0] == "1"))
        globalThis.parents = parents
        for (parent of parents.values()) {
            parent.parent = parent
        }
        const getParent = function (card) { //inefficient but whatevs
            let chain = card
            while (!chain.parent) chain = chain.after
            card.parent = chain.parent
        }
        const getChain = function (card) {
            let chain = [card]
            while (!parents.has(chain.at(-1))) chain.push(chain.at(-1).after)
            card.chain = chain
        }
        let worstLength = 1
        for (const card of cards.values()) {
            getParent(card)
            getChain(card)
            if (card.chain.length > worstLength) worstLength = card.chain.length
        }
        globalThis.worstLength = worstLength
        globalThis.worstChains = cards.values().filter(x => x.chain.length == worstLength)
        globalThis.worstSorted = Array.from(cards.values()).toSorted((u, w) => w.chain.length - u.chain.length)

        if (NRARRANGE && ADDBUTTONS) {
            const posBankThree = JSON.parse(
                `[["123",1302.837213464157,488.2379254179546],["132",1277.4833705471349,123.95491628336211],["213",1210.263718793411,734.3535065990553],["231",301.2530023841739,677.8476424172],["312",794.2836750349867,834.9963955017975],["321",813.41334025218,570.5004746187805]]`
            )
            const posBankFour = JSON.parse(
                `[["1234",1634.0392248571573,222.1758609209689],["1243",722.1181486069677,32.026276503475785],["1324",753.3725097335288,772.7398031036798],["1342",17.908468486120313,69.31051060139032],["1423",279.54463360216414,84.74969045641777],["1432",1143.3783245689438,35.03740795671216],["2134",1454.2303875714215,452.62083459429044],["2143",521.1840142589876,18.88088636530648],["2314",801.4600253767001,312.70904496751],["2341",74.69452362592926,674.366238981605],["2413",1279.0158707083986,908.0140491039765],["2431",304.96191914850584,830.9600032291039],["3124",1246.3307598472975,621.450853355226],["3142",354.29202403675987,400.23100274210447],["3214",1282.743828057845,248.60853608075803],["3241",301.2339617990595,576.7099336295365],["3412",929.4535792840168,20.457340271955864],["3421",83.39312237700355,853.1386158680692],["4123",1020.5435132982757,415.6703070466895],["4132",578.3462007635131,358.50116706029604],["4213",1133.2490827413155,723.1693028902059],["4231",519.5651988420894,724.4120206156949],["4312",1485.2966830156242,641.1440305432137],["4321",1678.096273448956,487.0358439747582]]`
            )
            const posBankFive = JSON.parse(
                `[["12345",1749.5967658142504,714.246025882732],["12354",697.7709625525233,22.80308778089208],["12435",924.2543789620182,102.15184856725145],["12453",1099.2809554560715,13.14614870210626],["12534",1298.4673729470092,9.914172538898452],["12543",1809.289948948505,248.82685694562474],["13245",1356.571251525892,173.1306569155097],["13254",1807.4555950767947,27.522884944319543],["13425",1557.050144090572,76.21656841499463],["13452",1709.2613367288852,18.430564336714937],["13524",1586.652040899093,15.235321499625307],["13542",323.8698863253635,26.32321230370418],["14235",1808.0915396703733,349.48873330258493],["14253",1569.122356801708,132.1215829500288],["14325",957.825171749306,354.19368322314267],["14352",1091.5442903224973,72.00887365843406],["14523",1488.747819354661,21.514205879407058],["14532",1777.1476668234495,75.85094637049497],["15234",1654.5542885475445,84.9432958818819],["15243",1821.9484869577484,145.3463835804154],["15324",907.4543846618487,10.506684873627254],["15342",303.4315549088538,117.60790328455444],["15423",1369.0884971946089,58.697447032232745],["15432",1402.008997755515,15.416303221638074],["21345",1648.7778173496456,814.3616940747671],["21354",564.9568464238683,22.629815724481183],["21435",820.2944748946097,171.70933018140036],["21453",993.878731836953,31.04560993057065],["21534",1209.6946364487656,28.558604690011585],["21543",1814.7352549789562,210.1814733004925],["23145",903.9522379529717,690.6279785941398],["23154",450.1065825385371,91.07171615752942],["23415",1153.8986351612396,390.65225323596667],["23451",1477.8322597360109,307.73332489606287],["23514",486.05710576189017,892.6152384066281],["23541",794.198340502425,521.1455212006948],["24135",1422.7646189441846,935.7014689434945],["24153",784.3592810073096,243.80447801400797],["24315",1134.7415232229473,167.06824282419237],["24351",1500.607805519873,363.62603936195546],["24513",1591.7884701262622,176.3451247436309],["24531",467.72551218215096,422.0552221265743],["25134",1656.101760327575,979.2991956057589],["25143",553.1084612939993,354.91554518050384],["25314",717.2320836539835,938.0383322454461],["25341",775.6526308515666,408.77282152379973],["25413",515.7363021891179,717.6488413869909],["25431",1366.8403903203941,129.72005647012287],["31245",1426.0976751028768,828.4506334970014],["31254",447.7721639552615,16.445318601268358],["31425",702.3232623609048,704.6711266320032],["31452",1300.5213431126724,1035.2773127917337],["31524",1235.9152862364563,312.20554008847756],["31542",1022.3585170816511,250.94882677935018],["32145",1162.9744313757597,671.6168724587993],["32154",622.228581187939,96.03199057891149],["32415",1211.0618424082686,353.1633235272819],["32451",1568.025115380939,303.52145093306547],["32514",600.4118271418083,898.2146507546223],["32541",897.3817344767273,512.0225225225224],["34125",808.5592619144529,350.83514404296875],["34152",1009.1549003501686,123.2727046272231],["34215",1040.5958771500684,181.51299144701008],["34251",1397.0942383712,352.06162692432446],["34512",1444.8411986672184,757.1937318933698],["34521",1493.0110820132325,609.7347686555102],["35124",798.6538617110347,31.901393383352804],["35142",153.50288979685746,168.95835451636358],["35214",659.3453198862123,1001.1702880859376],["35241",681.223037622301,420.9802211180577],["35412",48.09405255960219,57.062086945064834],["35421",592.4661273369488,493.21524405264654],["41235",877.1998509785897,628.6531531531533],["41253",678.6182072952577,286.55577568535347],["41325",803.4142931776825,710.3828828828829],["41352",1402.1604156372268,1024.1364292263609],["41523",455.28304671313697,349.60448668883737],["41532",51.311272843874136,198.92807743355158],["42135",1422.8436063069958,886.6855232307504],["42153",874.4710389383686,219.13544283339724],["42315",1245.2274031496468,173.51298010986244],["42351",1584.7800702280329,348.3738293347058],["42513",1703.3150776999148,155.56031335993694],["42531",556.0412881298539,414.14775920201316],["43125",1655.6959225642465,870.2660560343628],["43152",1106.2529629935875,283.71656267518654],["43215",1679.9153227911186,543.3577111046595],["43251",930.3075253956623,465.1306306306307],["43512",239.3225842216855,210.86407928797618],["43521",773.6344444313522,459.2927037144567],["45123",1518.4510365705505,246.84507313432357],["45132",922.6636488389336,282.76274255878997],["45213",1702.5717378882064,289.9323878932644],["45231",870.0765509309106,570.1486486486486],["45312",191.7984711782298,49.675345381771024],["45321",694.7247244815679,512.9378200221706],["51234",1565.5073164205503,495.4243510478251],["51243",956.5588485974447,201.9342102541049],["51324",1258.8175284012016,271.3410138302235],["51342",1124.0145204156267,239.9672679379293],["51423",1086.6493141584963,343.7829597135329],["51432",1073.075494293813,399.94146278725486],["52134",1663.3894952607407,927.9842940686098],["52143",676.2833863765557,355.2530907983179],["52314",727.5314554396572,850.3018018018018],["52341",945.721803153498,414.79906346776465],["52413",605.8812226621279,709.0261884809614],["52431",1467.5669245437098,101.28565740264037],["53124",1517.4050113946362,877.1558914871904],["53142",1423.8920458732102,981.0694228163711],["53214",770.0341378157648,637.741521611944],["53241",1700.3556651933693,344.68199088981567],["53412",723.4779100981177,187.76129036404137],["53421",725.1397267883668,120.43507430239828],["54123",1105.7781446027243,578.1955044033291],["54132",1060.2506919387772,955.6319081887594],["54213",1290.6210387511187,873.8328062810526],["54231",1286.026459466894,228.63797395844753],["54312",1547.2312690105205,766.2636000307707],["54321",1606.01074956322,648.2494248398789]]`
            )
            const posBank = [0, 1, 2, posBankThree, posBankFour, posBankFive][NR]
            for (const [str, x, y] of posBank)
                Object.assign(cards.get(str).button, { x, y })
        }
        const NRCOLORPARENT = true//NRARRANGE
        if (NRCOLORPARENT && ADDBUTTONS) {
            for (parent of parents.values()) {
                const color = MM.randomColor(180, 250)
                cards.values().filter(x => x.parent === parent).forEach(x =>
                    x.button.color = color
                )

            }
        }

        if (NR >= 6) { //rearrange if 6
            Rect.packCol(Array.from(parents.values().map(x => x.button)), game.rect.copy)
            for (const parent of parents) {
                const kids = Array.from(cards.values().filter(x => x.parent === parent).map(x => x.button))
                Rect.packRow(kids, parent.button.copy.resize(100, 1000))
            }
            const rightmost = cards.values().map(x => x.button.right).reduce((s, t) => s < t ? s : t)
            cards.values().map(x => x.button).forEach(x => x.x = rightmost - x.x + 1800)
            // cards.values().map(x => x.button).forEach(x => x.y += MM.random(-20, 20))
        }



    }


    //#endregion
    ///end initialize_more^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ///                                         ^^^^INITIALIZE^^^^                                                   ///
    ///                                                                                                              ///
    ///                                               UPDATE                                                         ///
    /// start update_more:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
    //#region update_more
    update_more(dt) {









    }

    //#endregion
    ///end update_more^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ///                                           ^^^^UPDATE^^^^                                                     ///
    ///                                                                                                              ///
    ///                                                DRAW                                                          ///
    ///start update_more::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
    //#region draw_more
    draw_more(screen) {
        const cards = window.cards
        for (const card of cards.values()) {
            if (!card.after || !card.button) continue
            MM.drawArrow(screen,
                card.button.x, card.button.y,
                card.after.button.x, card.after.button.y,
                { color: card.afterArrowColor, width: 3, size: 15 }
            )
        }








    }
    //#endregion
    ///end draw_more^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ///                                            ^^^^DRAW^^^^                                                      ///
    ///                                                                                                              ///
    ///                                              NEXT_LOOP                                                       ///
    ///start next_loop_more:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
    //#region next_loop_more
    next_loop_more() {




    }//#endregion
    ///end next_loop_more^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ///                                          ^^^^NEXT_LOOP^^^^                                                   ///
    ///                                                                                                              ///
    ///                                                                                                              ///
    /// ////////////////////////////////////////////////////////////////////////////////////////////////////////////////




} //this is the last closing brace for class Game

//#region dev options
/// dev options
const dev = {
    getPosBank: () => JSON.stringify(Array.from(cards.values().map(x => [x.str, x.button.x, x.button.y]))),
    setPosBank: (posBankStr) => posBankStr.forEach(([str, x, y]) => Object.assign(cards.get(str).button, { x, y }))

}/// end of dev


